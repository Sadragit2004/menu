{% extends "db_template.html" %}
{% load humanize %}

{% block content %}
<div class="w-full max-w-6xl mx-auto p-4 space-y-6">

    <!-- هدر اصلی -->
    <div class="bg-gradient-to-r from-blue-500 to-purple-600 rounded-2xl shadow-lg text-white p-8">
        <div class="flex flex-col lg:flex-row lg:items-center lg:justify-between">
            <div class="flex-1">
                <div class="flex items-center mb-4">
                    <div class="w-12 h-12 bg-white bg-opacity-20 rounded-xl flex items-center justify-center mr-4">
                        {% if order_type == 'menu' %}
                            <i class="fas fa-utensils text-2xl"></i>
                        {% elif order_type == 'plan' %}
                            <i class="fas fa-crown text-2xl"></i>
                        {% else %}
                            <i class="fas fa-box text-2xl"></i>
                        {% endif %}
                    </div>
                    <div>
                        <h1 class="text-3xl font-bold">
                            {% if order_type == 'menu' %}
                                سفارش منو #{{ order.id }}
                            {% elif order_type == 'plan' %}
                                سفارش پلن #{{ order.id }}
                            {% else %}
                                سفارش محصول #{{ order.id }}
                            {% endif %}
                        </h1>
                        <p class="text-blue-100 mt-2">
                            {% if order_type == 'menu' %}
                                جزئیات کامل سفارش ساخت منوی دیجیتال
                            {% elif order_type == 'plan' %}
                                جزئیات کامل سفارش پلن
                            {% else %}
                                جزئیات کامل سفارش محصول
                            {% endif %}
                        </p>
                    </div>
                </div>

                <!-- اطلاعات سریع -->
                <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mt-6">
                    {% if order_type == 'menu' %}
                    <div class="bg-white bg-opacity-10 rounded-xl p-4">
                        <p class="text-blue-100 text-sm">رستوران</p>
                        <p class="font-bold text-lg">{{ order.restaurant.title }}</p>
                    </div>
                    {% elif order_type == 'plan' %}
                    <div class="bg-white bg-opacity-10 rounded-xl p-4">
                        <p class="text-blue-100 text-sm">پلن</p>
                        <p class="font-bold text-lg">{{ order.plan.name }}</p>
                    </div>
                    {% else %}
                    <div class="bg-white bg-opacity-10 rounded-xl p-4">
                        <p class="text-blue-100 text-sm">تعداد آیتم‌ها</p>
                        <p class="font-bold text-lg">{{ order.items.count }} محصول</p>
                    </div>
                    {% endif %}

                    <div class="bg-white bg-opacity-10 rounded-xl p-4">
                        <p class="text-blue-100 text-sm">مبلغ نهایی</p>
                        <p class="font-bold text-lg">
                            {% if order_type == 'menu' %}
                                {{ order.get_price_display }}
                            {% elif order_type == 'plan' %}
                                {{ order.finalPrice|intcomma }} تومان
                            {% else %}
                                {{ order.final_price|intcomma }} تومان
                            {% endif %}
                        </p>
                    </div>

                    <div class="bg-white bg-opacity-10 rounded-xl p-4">
                        <p class="text-blue-100 text-sm">تاریخ ثبت</p>
                        <p class="font-bold text-lg">
                            {% if order_type == 'menu' %}
                                {{ order.created_at|date:"Y/m/d" }}
                            {% elif order_type == 'plan' %}
                                {{ order.createdAt|date:"Y/m/d" }}
                            {% else %}
                                {{ order.createdAt|date:"Y/m/d" }}
                            {% endif %}
                        </p>
                    </div>
                </div>
            </div>

            <!-- وضعیت و دکمه‌های اقدام -->
            <div class="mt-6 lg:mt-0 lg:mr-6">
                <div class="flex flex-col space-y-4">
                    <!-- وضعیت سفارش -->
                    <div class="bg-white bg-opacity-20 rounded-xl p-4 text-center">
                        <span class="status-badge px-4 py-2 rounded-lg text-sm font-medium
                            {% if status_info.is_paid %}bg-green-500 text-white{% else %}bg-red-500 text-white{% endif %}">
                            <i class="fas {% if status_info.is_paid %}fa-check-circle{% else %}fa-clock{% endif %} ml-2"></i>
                            {{ status_info.display }}
                        </span>
                    </div>

                    <!-- دکمه‌های اقدام -->
                    <div class="flex flex-col space-y-2">
                        {% if not status_info.is_paid %}
                        <button onclick="processPayment('{{ order_type }}', {{ order.id }})"
                                class="bg-white text-blue-600 hover:bg-blue-50 px-6 py-3 rounded-xl font-bold text-sm transition-all duration-300 flex items-center justify-center">
                            <i class="fas fa-credit-card ml-2"></i>
                            پرداخت سفارش
                        </button>
                        {% endif %}

                        {% if order_type == 'menu' and status_info.is_paid %}
                        <a href="/menu/{{ order.restaurant.english_name }}" target="_blank"
                           class="bg-white text-green-600 hover:bg-green-50 px-6 py-3 rounded-xl font-bold text-sm transition-all duration-300 flex items-center justify-center">
                            <i class="fas fa-eye ml-2"></i>
                            مشاهده منو
                        </a>

                        <button onclick="generateQRCode('{{ order.restaurant.slug }}')"
                                class="bg-white text-purple-600 hover:bg-purple-50 px-6 py-3 rounded-xl font-bold text-sm transition-all duration-300 flex items-center justify-center">
                            <i class="fas fa-qrcode ml-2"></i>
                            دریافت QR Code
                        </button>
                        {% endif %}

                        <a href="{% url 'panel:panel' %}"
                           class="bg-white bg-opacity-20 text-white hover:bg-opacity-30 px-6 py-3 rounded-xl font-bold text-sm transition-all duration-300 flex items-center justify-center">
                            <i class="fas fa-arrow-right ml-2"></i>
                            بازگشت به پنل
                        </a>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- محتوای سفارش بر اساس نوع -->
    {% if order_type == 'menu' %}
        <!-- محتوای سفارش منو -->
        <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
            <!-- اطلاعات رستوران -->
            <div class="bg-white rounded-2xl shadow-sm border border-gray-100 p-6">
                <div class="flex items-center mb-6">
                    <div class="w-10 h-10 bg-blue-100 rounded-xl flex items-center justify-center text-blue-600 mr-3">
                        <i class="fas fa-store"></i>
                    </div>
                    <h2 class="text-xl font-bold text-gray-800">اطلاعات رستوران</h2>
                </div>

                <div class="space-y-4">
                    <div class="flex items-center justify-between p-3 bg-gray-50 rounded-lg">
                        <span class="text-gray-600 flex items-center">
                            <i class="fas fa-signature ml-2 text-gray-400"></i>
                            نام رستوران:
                        </span>
                        <span class="font-bold text-gray-800">{{ order.restaurant.title }}</span>
                    </div>

                    <div class="flex items-center justify-between p-3 bg-gray-50 rounded-lg">
                        <span class="text-gray-600 flex items-center">
                            <i class="fas fa-globe ml-2 text-gray-400"></i>
                            نام انگلیسی:
                        </span>
                        <span class="font-bold text-gray-800">{{ order.restaurant.english_name }}</span>
                    </div>

                    <div class="flex items-center justify-between p-3 bg-gray-50 rounded-lg">
                        <span class="text-gray-600 flex items-center">
                            <i class="fas fa-link ml-2 text-gray-400"></i>
                            آدرس منو:
                        </span>
                        <span class="font-bold text-blue-600">/menu/{{ order.restaurant.english_name }}</span>
                    </div>
                </div>
            </div>

            <!-- اطلاعات پرداخت -->
            <div class="bg-white rounded-2xl shadow-sm border border-gray-100 p-6">
                <div class="flex items-center mb-6">
                    <div class="w-10 h-10 bg-green-100 rounded-xl flex items-center justify-center text-green-600 mr-3">
                        <i class="fas fa-credit-card"></i>
                    </div>
                    <h2 class="text-xl font-bold text-gray-800">اطلاعات پرداخت</h2>
                </div>

                <div class="space-y-4">
                    <div class="bg-gradient-to-r from-green-50 to-emerald-50 border border-green-200 rounded-xl p-4">
                        <div class="text-center mb-3">
                            <p class="text-gray-600 text-sm">مبلغ نهایی</p>
                            <p class="text-2xl font-bold text-green-600">{{ order.get_price_display }}</p>
                        </div>

                        <div class="space-y-2">
                            <div class="flex justify-between items-center text-sm">
                                <span class="text-gray-600">قیمت پایه:</span>
                                <span class="font-medium">{{ order.get_base_price_display }}</span>
                            </div>

                            {% if order.is_seo_enabled %}
                            <div class="flex justify-between items-center text-sm">
                                <span class="text-purple-600">هزینه سئو:</span>
                                <span class="font-medium text-purple-600">+ {{ order.get_seo_price_display }}</span>
                            </div>
                            {% endif %}
                        </div>
                    </div>
                </div>
            </div>

            <!-- وضعیت پیشرفت -->
            <div class="bg-white rounded-2xl shadow-sm border border-gray-100 p-6">
                <div class="flex items-center mb-6">
                    <div class="w-10 h-10 bg-purple-100 rounded-xl flex items-center justify-center text-purple-600 mr-3">
                        <i class="fas fa-tasks"></i>
                    </div>
                    <h2 class="text-xl font-bold text-gray-800">وضعیت پیشرفت</h2>
                </div>

                <div class="relative">
                    <div class="absolute right-6 top-0 bottom-0 w-1 bg-gray-200 transform -translate-x-1/2"></div>

                    <div class="space-y-8 relative">
                        <!-- مرحله 1: ثبت سفارش -->
                        <div class="flex items-start space-x-4 space-x-reverse">
                            <div class="w-12 h-12 rounded-full bg-green-500 flex items-center justify-center flex-shrink-0 z-10 shadow-lg">
                                <i class="fas fa-check text-white text-lg"></i>
                            </div>
                            <div class="flex-1 pt-2">
                                <h3 class="font-bold text-gray-800 text-lg">ثبت سفارش</h3>
                                <p class="text-gray-600 mt-1">سفارش شما با موفقیت ثبت شد</p>
                            </div>
                        </div>

                        <!-- مرحله 2: پرداخت -->
                        <div class="flex items-start space-x-4 space-x-reverse">
                            <div class="w-12 h-12 rounded-full flex items-center justify-center flex-shrink-0 z-10 shadow-lg
                                {% if status_info.is_paid %}bg-green-500{% else %}bg-gray-300{% endif %}">
                                {% if status_info.is_paid %}
                                <i class="fas fa-check text-white text-lg"></i>
                                {% else %}
                                <i class="fas fa-credit-card text-white text-lg"></i>
                                {% endif %}
                            </div>
                            <div class="flex-1 pt-2">
                                <h3 class="font-bold text-gray-800 text-lg">پرداخت</h3>
                                <p class="text-gray-600 mt-1">
                                    {% if status_info.is_paid %}
                                    پرداخت با موفقیت انجام شد
                                    {% else %}
                                    در انتظار پرداخت
                                    {% endif %}
                                </p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- عکس‌های آپلود شده -->
        {% if menu_images %}
        <div class="bg-white rounded-2xl shadow-sm border border-gray-100 p-6">
            <div class="flex items-center justify-between mb-6">
                <div class="flex items-center">
                    <div class="w-10 h-10 bg-indigo-100 rounded-xl flex items-center justify-center text-indigo-600 mr-3">
                        <i class="fas fa-images"></i>
                    </div>
                    <div>
                        <h2 class="text-xl font-bold text-gray-800">عکس‌های آپلود شده</h2>
                        <p class="text-gray-600 text-sm mt-1">عکس‌های منوی فعلی شما برای ساخت منوی دیجیتال</p>
                    </div>
                </div>
                <span class="bg-indigo-100 text-indigo-600 px-3 py-1 rounded-lg text-sm font-bold">
                    {{ menu_images.count }} عکس
                </span>
            </div>

            <div class="grid grid-cols-2 md:grid-cols-3 lg:grid-cols-4 xl:grid-cols-5 gap-4">
                {% for image in menu_images %}
                <div class="relative group">
                    <div class="aspect-w-4 aspect-h-3 bg-gray-100 rounded-xl overflow-hidden border-2 border-gray-200 group-hover:border-indigo-400 transition-all duration-300">
                        <img src="{{ image.image.url }}"
                             alt="عکس منو {{ forloop.counter }}"
                             class="w-full h-48 object-cover cursor-pointer transition-transform duration-300 group-hover:scale-105"
                             onclick="viewImage('{{ image.image.url }}')">
                    </div>
                </div>
                {% endfor %}
            </div>
        </div>
        {% endif %}

    {% elif order_type == 'plan' %}
        <!-- محتوای سفارش پلن -->
        <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
            <!-- اطلاعات پلن -->
            <div class="bg-white rounded-2xl shadow-sm border border-gray-100 p-6">
                <div class="flex items-center mb-6">
                    <div class="w-10 h-10 bg-purple-100 rounded-xl flex items-center justify-center text-purple-600 mr-3">
                        <i class="fas fa-crown"></i>
                    </div>
                    <h2 class="text-xl font-bold text-gray-800">اطلاعات پلن</h2>
                </div>

                <div class="space-y-4">
                    <div class="flex items-center justify-between p-3 bg-gray-50 rounded-lg">
                        <span class="text-gray-600">نام پلن:</span>
                        <span class="font-bold text-gray-800">{{ order.plan.name }}</span>
                    </div>

                    <div class="flex items-center justify-between p-3 bg-gray-50 rounded-lg">
                        <span class="text-gray-600">قیمت:</span>
                        <span class="font-bold text-green-600">{{ order.finalPrice|intcomma }} تومان</span>
                    </div>

                    <div class="flex items-center justify-between p-3 bg-gray-50 rounded-lg">
                        <span class="text-gray-600">مدت اعتبار:</span>
                        <span class="font-bold text-blue-600">{{ order.plan.expiryDays }} روز</span>
                    </div>

                    {% if order.expiryDate %}
                    <div class="flex items-center justify-between p-3 bg-gray-50 rounded-lg">
                        <span class="text-gray-600">تاریخ انقضا:</span>
                        <span class="font-bold {% if order.is_expired %}text-red-600{% else %}text-green-600{% endif %}">
                            {{ order.expiryDate|date:"Y/m/d" }}
                        </span>
                    </div>

                    <div class="flex items-center justify-between p-3 bg-gray-50 rounded-lg">
                        <span class="text-gray-600">روزهای باقی‌مانده:</span>
                        <span class="font-bold text-orange-600">{{ order.days_remaining }} روز</span>
                    </div>
                    {% endif %}
                </div>
            </div>

            <!-- ویژگی‌های پلن -->
            <div class="bg-white rounded-2xl shadow-sm border border-gray-100 p-6">
                <div class="flex items-center mb-6">
                    <div class="w-10 h-10 bg-blue-100 rounded-xl flex items-center justify-center text-blue-600 mr-3">
                        <i class="fas fa-star"></i>
                    </div>
                    <h2 class="text-xl font-bold text-gray-800">ویژگی‌های پلن</h2>
                </div>

                {% if order.plan.features.all %}
                <div class="space-y-3">
                    {% for feature in order.plan.features.all %}
                    <div class="flex items-center p-3 bg-gray-50 rounded-lg">
                        <i class="fas fa-check text-green-500 ml-3"></i>
                        <span class="text-gray-800">{{ feature.title }}{% if feature.value %}: <strong>{{ feature.value }}</strong>{% endif %}</span>
                    </div>
                    {% endfor %}
                </div>
                {% else %}
                <div class="text-center py-8">
                    <p class="text-gray-500">این پلن هیچ ویژگی خاصی ندارد</p>
                </div>
                {% endif %}
            </div>
        </div>

    {% else %}
        <!-- محتوای سفارش محصول -->
        <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
            <!-- اطلاعات محصولات -->
            <div class="lg:col-span-2 bg-white rounded-2xl shadow-sm border border-gray-100 p-6">
                <div class="flex items-center mb-6">
                    <div class="w-10 h-10 bg-orange-100 rounded-xl flex items-center justify-center text-orange-600 mr-3">
                        <i class="fas fa-box"></i>
                    </div>
                    <h2 class="text-xl font-bold text-gray-800">محصولات سفارش</h2>
                </div>

                <div class="space-y-4">
                    {% for item in order.items.all %}
                    <div class="border border-gray-200 rounded-xl p-4 hover:shadow-md transition-all duration-300">
                        <div class="flex justify-between items-start">
                            <div class="flex-1">
                                <h3 class="font-bold text-gray-800 text-lg">{{ item.product_name }}</h3>
                                <p class="text-gray-600 mt-2">{{ item.product_description|truncatewords:20 }}</p>
                                <div class="flex items-center mt-3 space-x-4 space-x-reverse">
                                    <span class="bg-blue-100 text-blue-600 px-3 py-1 rounded-lg text-sm font-medium">
                                        {{ item.quantity }} عدد
                                    </span>
                                    <span class="bg-green-100 text-green-600 px-3 py-1 rounded-lg text-sm font-medium">
                                        {{ item.price|intcomma }} تومان
                                    </span>
                                </div>
                            </div>
                            <div class="text-right ml-4">
                                <p class="text-xl font-bold text-gray-800">{{ item.total_price|intcomma }} تومان</p>
                                <p class="text-gray-500 text-sm mt-1">جمع آیتم</p>
                            </div>
                        </div>
                    </div>
                    {% endfor %}
                </div>
            </div>

            <!-- خلاصه سفارش -->
            <div class="bg-white rounded-2xl shadow-sm border border-gray-100 p-6">
                <div class="flex items-center mb-6">
                    <div class="w-10 h-10 bg-green-100 rounded-xl flex items-center justify-center text-green-600 mr-3">
                        <i class="fas fa-receipt"></i>
                    </div>
                    <h2 class="text-xl font-bold text-gray-800">خلاصه سفارش</h2>
                </div>

                <div class="space-y-4">
                    <div class="flex justify-between items-center p-3 bg-gray-50 rounded-lg">
                        <span class="text-gray-600">قیمت کل:</span>
                        <span class="font-bold">{{ order.total_price|intcomma }} تومان</span>
                    </div>

                    <div class="flex justify-between items-center p-3 bg-gray-50 rounded-lg">
                        <span class="text-gray-600">مالیات (۹٪):</span>
                        <span class="font-bold text-blue-600">{{ order.tax_amount|intcomma }} تومان</span>
                    </div>

                    <div class="flex justify-between items-center p-3 bg-green-50 rounded-lg border border-green-200">
                        <span class="text-gray-800 font-semibold">قیمت نهایی:</span>
                        <span class="font-bold text-green-600 text-lg">{{ order.final_price|intcomma }} تومان</span>
                    </div>

                    <div class="flex justify-between items-center p-3 bg-gray-50 rounded-lg">
                        <span class="text-gray-600">تعداد آیتم‌ها:</span>
                        <span class="font-bold">{{ order.items.count }} محصول</span>
                    </div>
                </div>
            </div>
        </div>
    {% endif %}

    <!-- اطلاعات فنی -->
    <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
        <!-- اطلاعات فنی سفارش -->
        <div class="bg-white rounded-2xl shadow-sm border border-gray-100 p-6">
            <div class="flex items-center mb-6">
                <div class="w-10 h-10 bg-gray-100 rounded-xl flex items-center justify-center text-gray-600 mr-3">
                    <i class="fas fa-cogs"></i>
                </div>
                <h2 class="text-xl font-bold text-gray-800">اطلاعات فنی</h2>
            </div>

            <div class="space-y-3">
                <div class="flex justify-between items-center p-3 bg-gray-50 rounded-lg">
                    <span class="text-gray-600">شناسه سفارش:</span>
                    <span class="font-mono font-bold text-gray-800">#{{ order.id }}</span>
                </div>

                <div class="flex justify-between items-center p-3 bg-gray-50 rounded-lg">
                    <span class="text-gray-600">نوع سفارش:</span>
                    <span class="font-bold
                        {% if order_type == 'menu' %}text-green-600{% endif %}
                        {% if order_type == 'plan' %}text-purple-600{% endif %}
                        {% if order_type == 'product' %}text-orange-600{% endif %}">
                        {% if order_type == 'menu' %}منو{% endif %}
                        {% if order_type == 'plan' %}پلن{% endif %}
                        {% if order_type == 'product' %}محصول{% endif %}
                    </span>
                </div>

                <div class="flex justify-between items-center p-3 bg-gray-50 rounded-lg">
                    <span class="text-gray-600">تاریخ ایجاد در سیستم:</span>
                    <span class="font-mono text-sm text-gray-800">
                        {% if order_type == 'menu' %}
                            {{ order.created_at|date:"Y/m/d - H:i:s" }}
                        {% else %}
                            {{ order.createdAt|date:"Y/m/d - H:i:s" }}
                        {% endif %}
                    </span>
                </div>

                <div class="flex justify-between items-center p-3 bg-gray-50 rounded-lg">
                    <span class="text-gray-600">وضعیت پرداخت:</span>
                    <span class="font-bold {% if status_info.is_paid %}text-green-600{% else %}text-red-600{% endif %}">
                        {% if status_info.is_paid %}پرداخت شده{% else %}پرداخت نشده{% endif %}
                    </span>
                </div>
            </div>
        </div>

        <!-- اقدامات سریع -->
        <div class="bg-white rounded-2xl shadow-sm border border-gray-100 p-6">
            <div class="flex items-center mb-6">
                <div class="w-10 h-10 bg-orange-100 rounded-xl flex items-center justify-center text-orange-600 mr-3">
                    <i class="fas fa-bolt"></i>
                </div>
                <h2 class="text-xl font-bold text-gray-800">اقدامات سریع</h2>
            </div>

            <div class="space-y-3">
                {% if not status_info.is_paid %}
                <button onclick="processPayment('{{ order_type }}', {{ order.id }})"
                        class="w-full bg-red-500 hover:bg-red-600 text-white px-4 py-4 rounded-xl font-bold text-sm transition-all duration-300 flex items-center justify-center transform hover:scale-105">
                    <i class="fas fa-credit-card ml-2 text-lg"></i>
                    پرداخت سفارش
                </button>

                <button onclick="cancelOrder('{{ order_type }}', {{ order.id }})"
                        class="w-full border border-red-300 hover:bg-red-50 text-red-600 px-4 py-4 rounded-xl font-bold text-sm transition-all duration-300 flex items-center justify-center">
                    <i class="fas fa-times ml-2"></i>
                    لغو سفارش
                </button>
                {% endif %}

                {% if order_type == 'menu' and status_info.is_paid %}
                <a href="/menu/{{ order.restaurant.english_name }}" target="_blank"
                   class="w-full bg-green-500 hover:bg-green-600 text-white px-4 py-4 rounded-xl font-bold text-sm transition-all duration-300 flex items-center justify-center transform hover:scale-105">
                    <i class="fas fa-external-link-alt ml-2"></i>
                    مشاهده منو در تب جدید
                </a>

                <button onclick="generateQRCode('{{ order.restaurant.slug }}')"
                        class="w-full bg-purple-500 hover:bg-purple-600 text-white px-4 py-4 rounded-xl font-bold text-sm transition-all duration-300 flex items-center justify-center transform hover:scale-105">
                    <i class="fas fa-qrcode ml-2 text-lg"></i>
                    تولید QR Code
                </button>

                <button onclick="copyMenuLink('{{ order.restaurant.english_name }}')"
                        class="w-full bg-blue-500 hover:bg-blue-600 text-white px-4 py-4 rounded-xl font-bold text-sm transition-all duration-300 flex items-center justify-center transform hover:scale-105">
                    <i class="fas fa-copy ml-2"></i>
                    کپی لینک منو
                </button>
                {% endif %}

                <a href="{% url 'panel:panel' %}"
                   class="w-full border border-gray-300 hover:bg-gray-50 text-gray-600 px-4 py-4 rounded-xl font-bold text-sm transition-all duration-300 flex items-center justify-center">
                    <i class="fas fa-arrow-right ml-2"></i>
                    بازگشت به پنل اصلی
                </a>
            </div>
        </div>
    </div>
</div>

<!-- مودال نمایش عکس -->
<div id="imageModal" class="fixed inset-0 bg-black bg-opacity-90 hidden z-50 transition-all duration-300">
    <div class="flex items-center justify-center min-h-screen p-4">
        <div class="relative w-full max-w-6xl">
            <button onclick="closeImageModal()"
                    class="absolute -top-16 left-0 text-white text-3xl hover:text-gray-300 transition-colors p-2">
                <i class="fas fa-times"></i>
            </button>
            <img id="modalImage" src="" alt="عکس منو" class="w-full h-auto rounded-2xl shadow-2xl">
        </div>
    </div>
</div>

<!-- مودال QR Code -->
<div id="qrCodeModal" class="fixed inset-0 bg-black bg-opacity-50 hidden z-50 transition-all duration-300">
    <div class="flex items-center justify-center min-h-screen p-4">
        <div class="bg-white rounded-2xl shadow-xl w-full max-w-md transform transition-all duration-300 scale-95">
            <div class="flex justify-between items-center p-6 border-b border-gray-200">
                <h3 class="text-xl font-bold text-gray-800">QR Code منو</h3>
                <button onclick="closeQRCodeModal()"
                        class="text-gray-500 hover:text-gray-700 transition-colors p-2 rounded-lg hover:bg-gray-100">
                    <i class="fas fa-times text-lg"></i>
                </button>
            </div>
            <div class="p-6 text-center">
                <div id="qrCodeContainer" class="mb-6">
                    <!-- QR Code اینجا نمایش داده می‌شود -->
                </div>
                <p class="text-gray-600 text-sm mb-6 leading-relaxed">
                    اسکن کنید تا مستقیماً به منوی شما هدایت شوید
                </p>
                <div class="flex space-x-3 space-x-reverse">
                    <button onclick="downloadQRCode()"
                            class="flex-1 bg-blue-500 hover:bg-blue-600 text-white px-4 py-3 rounded-xl text-sm font-bold transition-all duration-300 transform hover:scale-105 flex items-center justify-center">
                        <i class="fas fa-download ml-2"></i>
                        دانلود
                    </button>
                    <button onclick="printQRCode()"
                            class="flex-1 bg-green-500 hover:bg-green-600 text-white px-4 py-3 rounded-xl text-sm font-bold transition-all duration-300 transform hover:scale-105 flex items-center justify-center">
                        <i class="fas fa-print ml-2"></i>
                        چاپ
                    </button>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
// پرداخت سفارش
function processPayment(orderType, orderId) {
    if (confirm('آیا می‌خواهید به درگاه پرداخت منتقل شوید؟')) {
        showNotification('در حال انتقال به درگاه پرداخت...', 'info');

        if (orderType === 'menu') {
            window.location.href = `/peyment/request/menu/${orderId}/`;
        } else if (orderType === 'plan') {
            window.location.href = `/peyment/request/plan/${orderId}/`;
        } else if (orderType === 'product') {
            window.location.href = `/peyment/request/product/${orderId}/`;
        }
    }
}

// لغو سفارش
function cancelOrder(orderType, orderId) {
    if (confirm('آیا از لغو این سفارش مطمئن هستید؟ این عمل غیرقابل بازگشت است.')) {
        showNotification('در حال لغو سفارش...', 'info');

        fetch(`/panel/orders/${orderType}/${orderId}/cancel/`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': '{{ csrf_token }}'
            }
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                showNotification('سفارش با موفقیت لغو شد ✅', 'success');
                setTimeout(() => {
                    window.location.href = "{% url 'panel:panel' %}";
                }, 2000);
            } else {
                showNotification('خطا در لغو سفارش: ' + data.message, 'error');
            }
        })
        .catch(error => {
            console.error('Error:', error);
            showNotification('خطا در ارتباط با سرور ❌', 'error');
        });
    }
}

// مشاهده عکس در مودال
function viewImage(imageUrl) {
    const modal = document.getElementById('imageModal');
    const modalImage = document.getElementById('modalImage');

    modalImage.src = imageUrl;
    modal.classList.remove('hidden');

    setTimeout(() => {
        modal.style.opacity = '1';
    }, 10);
}

function closeImageModal() {
    const modal = document.getElementById('imageModal');
    modal.style.opacity = '0';
    setTimeout(() => {
        modal.classList.add('hidden');
    }, 300);
}

// کپی لینک منو
function copyMenuLink(englishName) {
    const link = `${window.location.origin}/menu/${englishName}`;
    navigator.clipboard.writeText(link).then(() => {
        showNotification('لینک منو در کلیپ‌بورد کپی شد ✅', 'success');
    }).catch(() => {
        showNotification('خطا در کپی لینک ❌', 'error');
    });
}

// تولید QR Code
function generateQRCode(restaurantSlug) {
    const qrCodeModal = document.getElementById('qrCodeModal');
    const qrCodeContainer = document.getElementById('qrCodeContainer');

    qrCodeContainer.innerHTML = `
        <div class="py-8">
            <div class="w-16 h-16 bg-blue-100 rounded-full flex items-center justify-center text-blue-500 mx-auto mb-4">
                <i class="fas fa-spinner fa-spin text-2xl"></i>
            </div>
            <p class="text-gray-600">در حال تولید QR Code...</p>
        </div>
    `;

    qrCodeModal.classList.remove('hidden');

    setTimeout(() => {
        qrCodeModal.querySelector('.scale-95').classList.remove('scale-95');
    }, 10);

    fetch(`/panel/generate-qr/${restaurantSlug}/`)
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                qrCodeContainer.innerHTML = `
                    <img src="${data.qr_code}" alt="QR Code" class="w-64 h-64 mx-auto border-4 border-white rounded-2xl shadow-lg">
                    <p class="text-sm text-gray-600 mt-4 font-mono bg-gray-100 p-2 rounded-lg">${data.menu_url}</p>
                `;
            } else {
                qrCodeContainer.innerHTML = `
                    <div class="py-8">
                        <div class="w-16 h-16 bg-red-100 rounded-full flex items-center justify-center text-red-500 mx-auto mb-4">
                            <i class="fas fa-times text-2xl"></i>
                        </div>
                        <p class="text-gray-600">خطا در تولید QR Code</p>
                    </div>
                `;
            }
        })
        .catch(error => {
            console.error('Error:', error);
            qrCodeContainer.innerHTML = `
                <div class="py-8">
                    <div class="w-16 h-16 bg-red-100 rounded-full flex items-center justify-center text-red-500 mx-auto mb-4">
                        <i class="fas fa-times text-2xl"></i>
                    </div>
                    <p class="text-gray-600">خطا در ارتباط با سرور</p>
                </div>
            `;
        });
}

function closeQRCodeModal() {
    const modal = document.getElementById('qrCodeModal');
    modal.querySelector('.scale-95').classList.add('scale-95');
    setTimeout(() => {
        modal.classList.add('hidden');
    }, 300);
}

function downloadQRCode() {
    const qrCodeImg = document.querySelector('#qrCodeContainer img');
    if (qrCodeImg) {
        const link = document.createElement('a');
        link.download = 'qrcode-menu.png';
        link.href = qrCodeImg.src;
        link.click();
        showNotification('QR Code دانلود شد ✅', 'success');
    }
}

function printQRCode() {
    window.print();
}

// تابع نمایش نوتیفیکیشن
function showNotification(message, type = 'success') {
    const notification = document.createElement('div');
    notification.className = `fixed top-6 left-1/2 transform -translate-x-1/2 z-50 px-6 py-4 rounded-xl shadow-lg text-white font-bold text-sm ${
        type === 'success' ? 'bg-green-500' :
        type === 'error' ? 'bg-red-500' :
        'bg-blue-500'
    } animate-bounce`;
    notification.textContent = message;
    document.body.appendChild(notification);

    setTimeout(() => {
        notification.style.opacity = '0';
        setTimeout(() => {
            notification.remove();
        }, 300);
    }, 3000);
}

// مدیریت رویدادهای مودال
document.getElementById('imageModal').addEventListener('click', function(e) {
    if (e.target === this) {
        closeImageModal();
    }
});

document.getElementById('qrCodeModal').addEventListener('click', function(e) {
    if (e.target === this) {
        closeQRCodeModal();
    }
});

// بستن با دکمه ESC
document.addEventListener('keydown', function(e) {
    if (e.key === 'Escape') {
        closeImageModal();
        closeQRCodeModal();
    }
});

// انیمیشن‌های ظاهر شدن
document.addEventListener('DOMContentLoaded', function() {
    const elements = document.querySelectorAll('.bg-white');
    elements.forEach((el, index) => {
        setTimeout(() => {
            el.style.opacity = '0';
            el.style.transform = 'translateY(20px)';
            el.classList.remove('hidden');

            setTimeout(() => {
                el.style.transition = 'all 0.5s ease';
                el.style.opacity = '1';
                el.style.transform = 'translateY(0)';
            }, 50);
        }, index * 100);
    });
});
</script>

<style>
.status-badge {
    display: inline-flex;
    align-items: center;
    transition: all 0.3s ease;
}

.status-badge:hover {
    transform: scale(1.05);
}

.hover-lift:hover {
    transform: translateY(-4px);
    transition: transform 0.3s ease;
}

.animate-bounce {
    animation: bounce 0.5s;
}

@keyframes bounce {
    0%, 20%, 53%, 80%, 100% {
        transform: translate3d(-50%, 0, 0);
    }
    40%, 43% {
        transform: translate3d(-50%, -15px, 0);
    }
    70% {
        transform: translate3d(-50%, -10px, 0);
    }
    90% {
        transform: translate3d(-50%, -5px, 0);
    }
}

/* بهبود نمایش در موبایل */
@media (max-width: 768px) {
    .container {
        padding-left: 1rem;
        padding-right: 1rem;
    }
}

/* حذف اسکرول هنگام نمایش مودال */
body:has(#imageModal:not(.hidden)),
body:has(#qrCodeModal:not(.hidden)) {
    overflow: hidden;
}

/* transition delays برای انیمیشن‌های گروهی */
.delay-100 {
    transition-delay: 100ms;
}

.delay-200 {
    transition-delay: 200ms;
}
</style>
{% endblock content %}