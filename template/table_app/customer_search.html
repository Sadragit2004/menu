<!-- table_app/templates/table_app/customer_search.html -->
{% extends 'table_template.html' %}
{% load static %}

{% block title %}Ø¬Ø³ØªØ¬ÙˆÛŒ Ù…Ø´ØªØ±ÛŒ - Ø³ÛŒØ³ØªÙ… Ø±Ø²Ø±Ùˆ{% endblock %}
{% block page_title %}Ø¬Ø³ØªØ¬ÙˆÛŒ Ù…Ø´ØªØ±ÛŒ Ùˆ ØªØ§Ø±ÛŒØ®Ú†Ù‡ Ø±Ø²Ø±Ùˆ{% endblock %}

{% block content %}
<div class="max-w-4xl mx-auto">
    <!-- Ú©Ø§Ø±Øª Ø¬Ø³ØªØ¬Ùˆ -->
    <div class="bg-white rounded-lg shadow-md p-6 mb-6">
        <h3 class="text-lg font-semibold text-gray-800 mb-4">Ø¬Ø³ØªØ¬ÙˆÛŒ Ù…Ø´ØªØ±ÛŒ</h3>

        <div class="flex gap-4 mb-4">
            <div class="flex-1">
                <input
                    type="text"
                    id="phone_number"
                    placeholder="Ø´Ù…Ø§Ø±Ù‡ Ù…ÙˆØ¨Ø§ÛŒÙ„ Ù…Ø´ØªØ±ÛŒ (Ù…Ø«Ø§Ù„: 09123456789)"
                    class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500"
                    dir="ltr"
                >
            </div>
            <button
                onclick="searchCustomers()"
                class="bg-blue-600 hover:bg-blue-700 text-white px-6 py-3 rounded-lg flex items-center"
            >
                <i class="fas fa-search ml-2"></i>
                Ø¬Ø³ØªØ¬Ùˆ
            </button>
        </div>

        <div class="text-sm text-gray-600">
            <i class="fas fa-info-circle ml-2"></i>
            Ø´Ù…Ø§Ø±Ù‡ Ù…ÙˆØ¨Ø§ÛŒÙ„ Ù…Ø´ØªØ±ÛŒ Ø±Ø§ ÙˆØ§Ø±Ø¯ Ú©Ù†ÛŒØ¯
        </div>
    </div>

    <!-- ÙˆØ¶Ø¹ÛŒØª -->
    <div id="statusMessage"></div>

    <!-- Ù†ØªØ§ÛŒØ¬ Ø¬Ø³ØªØ¬Ùˆ -->
    <div id="searchResults">
        <div class="text-center py-12 bg-white rounded-lg shadow-md">
            <i class="fas fa-search text-gray-400 text-5xl mb-4"></i>
            <h3 class="text-gray-600 text-lg mb-2">Ø¯Ø± Ø§Ù†ØªØ¸Ø§Ø± Ø¬Ø³ØªØ¬Ùˆ</h3>
            <p class="text-gray-500">Ø´Ù…Ø§Ø±Ù‡ Ù…ÙˆØ¨Ø§ÛŒÙ„ Ù…Ø´ØªØ±ÛŒ Ø±Ø§ ÙˆØ§Ø±Ø¯ Ú©Ù†ÛŒØ¯</p>
        </div>
    </div>
</div>


<script>
// ØªØ§Ø¨Ø¹ Ø¬Ø³ØªØ¬Ùˆ
function searchCustomers() {
    console.log('ğŸ” Ø¬Ø³ØªØ¬Ùˆ Ø´Ø±ÙˆØ¹ Ø´Ø¯...');

    const phoneNumber = document.getElementById('phone_number').value.trim();
    const resultsDiv = document.getElementById('searchResults');
    const statusDiv = document.getElementById('statusMessage');

    if (!phoneNumber) {
        showStatus('Ù„Ø·ÙØ§Ù‹ Ø´Ù…Ø§Ø±Ù‡ Ù…ÙˆØ¨Ø§ÛŒÙ„ Ø±Ø§ ÙˆØ§Ø±Ø¯ Ú©Ù†ÛŒØ¯', 'error');
        return;
    }

    showStatus('Ø¯Ø± Ø­Ø§Ù„ Ø¬Ø³ØªØ¬Ùˆ...', 'info');

    // Ù†Ù…Ø§ÛŒØ´ Ù„ÙˆØ¯ÛŒÙ†Ú¯
    resultsDiv.innerHTML = `
        <div class="text-center py-8">
            <div class="inline-block animate-spin rounded-full h-8 w-8 border-b-2 border-blue-600"></div>
            <p class="text-gray-600 mt-2">Ø¯Ø± Ø­Ø§Ù„ Ø¬Ø³ØªØ¬Ùˆ...</p>
        </div>
    `;

    // Ø§Ø±Ø³Ø§Ù„ Ø¯Ø±Ø®ÙˆØ§Ø³Øª
    const formData = new FormData();
    formData.append('phone_number', phoneNumber);
    formData.append('csrfmiddlewaretoken', '{{ csrf_token }}');

    fetch('{% url "table:customer_search_api" %}', {
        method: 'POST',
        body: formData
    })
    .then(response => {
        console.log('ğŸ“¡ ÙˆØ¶Ø¹ÛŒØª Ù¾Ø§Ø³Ø®:', response.status);
        return response.json();
    })
    .then(data => {
        console.log('ğŸ“Š Ø¯Ø§Ø¯Ù‡ Ø¯Ø±ÛŒØ§ÙØª Ø´Ø¯:', data);
        hideStatus();

        if (data.success) {
            displaySearchResults(data);
        } else {
            showStatus('Ø®Ø·Ø§: ' + data.error, 'error');
            resultsDiv.innerHTML = `
                <div class="text-center py-12 bg-white rounded-lg shadow-md">
                    <i class="fas fa-exclamation-triangle text-red-400 text-5xl mb-4"></i>
                    <h3 class="text-red-600 text-lg mb-2">Ø®Ø·Ø§ Ø¯Ø± Ø¬Ø³ØªØ¬Ùˆ</h3>
                    <p class="text-red-500">${data.error}</p>
                </div>
            `;
        }
    })
    .catch(error => {
        console.error('âŒ Ø®Ø·Ø§ÛŒ fetch:', error);
        hideStatus();
        showStatus('Ø®Ø·Ø§ Ø¯Ø± Ø§Ø±ØªØ¨Ø§Ø· Ø¨Ø§ Ø³Ø±ÙˆØ±', 'error');
        resultsDiv.innerHTML = `
            <div class="text-center py-12 bg-white rounded-lg shadow-md">
                <i class="fas fa-exclamation-triangle text-red-400 text-5xl mb-4"></i>
                <h3 class="text-red-600 text-lg mb-2">Ø®Ø·Ø§ Ø¯Ø± Ø§Ø±ØªØ¨Ø§Ø·</h3>
                <p class="text-red-500">Ø®Ø·Ø§ Ø¯Ø± Ø¨Ø±Ù‚Ø±Ø§Ø±ÛŒ Ø§Ø±ØªØ¨Ø§Ø· Ø¨Ø§ Ø³Ø±ÙˆØ±</p>
            </div>
        `;
    });
}

// Ù†Ù…Ø§ÛŒØ´ ÙˆØ¶Ø¹ÛŒØª
function showStatus(message, type = 'info') {
    const statusDiv = document.getElementById('statusMessage');
    statusDiv.className = `p-4 rounded-lg mb-4 ${
        type === 'error' ? 'bg-red-100 text-red-700 border border-red-200' :
        type === 'success' ? 'bg-green-100 text-green-700 border border-green-200' :
        'bg-blue-100 text-blue-700 border border-blue-200'
    }`;
    statusDiv.innerHTML = `
        <div class="flex items-center">
            <i class="fas ${type === 'error' ? 'fa-exclamation-triangle' : type === 'success' ? 'fa-check-circle' : 'fa-info-circle'} ml-2"></i>
            <span>${message}</span>
        </div>
    `;
}

// Ù¾Ù†Ù‡Ø§Ù† Ú©Ø±Ø¯Ù† ÙˆØ¶Ø¹ÛŒØª
function hideStatus() {
    const statusDiv = document.getElementById('statusMessage');
    statusDiv.innerHTML = '';
    statusDiv.className = '';
}

// Ù†Ù…Ø§ÛŒØ´ Ù†ØªØ§ÛŒØ¬
function displaySearchResults(data) {
    const resultsDiv = document.getElementById('searchResults');

    if (data.count === 0) {
        resultsDiv.innerHTML = `
            <div class="text-center py-12 bg-white rounded-lg shadow-md">
                <i class="fas fa-user-slash text-gray-400 text-5xl mb-4"></i>
                <h3 class="text-gray-600 text-lg mb-2">Ù…Ø´ØªØ±ÛŒ ÛŒØ§ÙØª Ù†Ø´Ø¯</h3>
                <p class="text-gray-500">Ù‡ÛŒÚ† Ù…Ø´ØªØ±ÛŒ Ø¨Ø§ Ø§ÛŒÙ† Ø´Ù…Ø§Ø±Ù‡ Ù…ÙˆØ¨Ø§ÛŒÙ„ Ø«Ø¨Øª Ù†Ø´Ø¯Ù‡ Ø§Ø³Øª</p>
            </div>
        `;
        return;
    }

    let html = '';
    data.customers.forEach(customer => {
        html += createCustomerCard(customer);
    });
    resultsDiv.innerHTML = html;
}

// Ø§ÛŒØ¬Ø§Ø¯ Ú©Ø§Ø±Øª Ù…Ø´ØªØ±ÛŒ
function createCustomerCard(customer) {
    const lastReservation = customer.last_reservation;

    return `
    <div class="bg-white rounded-lg shadow-md p-6 mb-4 border-r-4 border-${customer.score_color}-500">
        <div class="flex flex-col lg:flex-row lg:items-center lg:justify-between gap-4">
            <div class="flex-1">
                <div class="flex items-center justify-between mb-3">
                    <div class="flex items-center">
                        <div class="w-12 h-12 bg-${customer.score_color}-100 rounded-full flex items-center justify-center ml-3">
                            <i class="fas fa-user text-${customer.score_color}-600"></i>
                        </div>
                        <div>
                            <h4 class="font-bold text-gray-800 text-lg">${customer.full_name}</h4>
                            <p class="text-gray-600 text-sm">${customer.phone_number} | ${customer.national_code}</p>
                        </div>
                    </div>
                    ${customer.is_vip ? '<span class="bg-yellow-100 text-yellow-800 px-3 py-1 rounded-full text-sm font-semibold">VIP</span>' : ''}
                </div>

                <div class="grid grid-cols-2 md:grid-cols-4 gap-4 mb-4">
                    <div class="text-center">
                        <div class="text-xl font-bold text-blue-600">${customer.total_reservations}</div>
                        <div class="text-gray-600 text-xs">Ú©Ù„ Ø±Ø²Ø±ÙˆÙ‡Ø§</div>
                    </div>
                    <div class="text-center">
                        <div class="text-xl font-bold text-green-600">${customer.successful_reservations}</div>
                        <div class="text-gray-600 text-xs">Ù…ÙˆÙÙ‚</div>
                    </div>
                    <div class="text-center">
                        <div class="text-xl font-bold text-red-600">${customer.cancellation_count}</div>
                        <div class="text-gray-600 text-xs">Ù„ØºÙˆ Ø´Ø¯Ù‡</div>
                    </div>
                    <div class="text-center">
                        <div class="text-xl font-bold text-purple-600">${customer.success_rate}%</div>
                        <div class="text-gray-600 text-xs">Ù†Ø±Ø® Ù…ÙˆÙÙ‚ÛŒØª</div>
                    </div>
                </div>

                ${lastReservation ? `
                <div class="bg-gray-50 rounded-lg p-3">
                    <div class="flex justify-between items-center text-sm">
                        <span class="text-gray-600">Ø¢Ø®Ø±ÛŒÙ† Ø±Ø²Ø±Ùˆ:</span>
                        <span class="font-semibold">${lastReservation.date} - Ù…ÛŒØ² ${lastReservation.table}</span>
                        <span class="bg-gray-200 text-gray-700 px-2 py-1 rounded text-xs">${lastReservation.status}</span>
                    </div>
                </div>
                ` : '<div class="bg-gray-50 rounded-lg p-3 text-center text-gray-500 text-sm">Ù‡ÛŒÚ† Ø±Ø²Ø±ÙˆÛŒ Ø«Ø¨Øª Ù†Ø´Ø¯Ù‡</div>'}
            </div>

            <div class="text-center lg:text-right">
                <div class="mb-2">
                    <span class="bg-${customer.score_color}-100 text-${customer.score_color}-800 px-3 py-1 rounded-full text-sm font-semibold">
                        ${customer.customer_score} Ø§Ù…ØªÛŒØ§Ø² - ${customer.score_label}
                    </span>
                </div>
                <button onclick="showCustomerDetail(${customer.id})"
                        class="bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded-lg flex items-center justify-center">
                    <i class="fas fa-eye ml-2"></i>
                    Ù…Ø´Ø§Ù‡Ø¯Ù‡ Ø¬Ø²Ø¦ÛŒØ§Øª
                </button>
            </div>
        </div>
    </div>
    `;
}

// Ù†Ù…Ø§ÛŒØ´ Ø¬Ø²Ø¦ÛŒØ§Øª Ù…Ø´ØªØ±ÛŒ
function showCustomerDetail(customerId) {
    alert('Ù†Ù…Ø§ÛŒØ´ Ø¬Ø²Ø¦ÛŒØ§Øª Ø¨Ø±Ø§ÛŒ Ù…Ø´ØªØ±ÛŒ Ø¨Ø§ ID: ' + customerId);
}

// Ø¬Ø³ØªØ¬Ùˆ Ø¨Ø§ Ú©Ù„ÛŒØ¯ Enter
document.getElementById('phone_number').addEventListener('keypress', function(e) {
    if (e.key === 'Enter') {
        searchCustomers();
    }
});

// ØªØ³Øª Ø³Ø§Ø¯Ù‡
console.log('âœ… JavaScript loaded successfully');
</script>
{% endblock %}
f=