<!-- table/templates/table/reservation_list.html -->
{% extends 'table_template.html' %}

{% block title %}مدیریت رزروها - سیستم رزرو{% endblock %}
{% block page_title %}مدیریت رزروها{% endblock %}

{% block content %}

<style>
    /* static/css/persian-datepicker.css */
.persian-datepicker {
    font-family: 'Vazir', 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
    direction: rtl;
}

.pdp-day:hover {
    background-color: #e2e8f0 !important;
}

.pdp-day-today {
    border: 2px solid #3b82f6 !important;
    font-weight: bold;
}

.pdp-day-selected {
    background-color: #3b82f6 !important;
    color: white !important;
}

.pdp-navigation button:hover {
    background-color: #e2e8f0 !important;
}

.pdp-footer button:hover {
    opacity: 0.9;
}
</style>

<div class="mb-6 flex flex-col sm:flex-row justify-between items-start sm:items-center space-y-3 sm:space-y-0">
    <div>
        <h2 class="text-xl font-semibold text-gray-800">لیست تمام رزروها</h2>
        <p class="text-gray-600">مدیریت و پیگیری رزروهای رستوران</p>
    </div>
    <div class="flex space-x-3 space-x-reverse">
        <a href="{% url 'table:dashboard' %}" class="bg-gray-500 hover:bg-gray-600 text-white px-4 py-2 rounded-lg flex items-center transition duration-200">
            <i class="fas fa-arrow-right ml-2"></i>
            بازگشت
        </a>
    </div>
</div>

<!-- فیلترها -->
<div class="bg-white rounded-lg shadow-md p-4 mb-6">
    <form method="get" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4">
        <!-- تاریخ شمسی -->
        <div>
            <label class="block text-sm font-medium text-gray-700 mb-1">تاریخ (شمسی)</label>
            <input type="text" name="date" value="{{ request.GET.date }}"
                   class="w-full border border-gray-300 rounded-lg px-3 py-2 focus:outline-none focus:ring-2 focus:ring-blue-500"
                   placeholder="مثال: 1403/09/01"
                   pattern="\d{4}/\d{2}/\d{2}">
            <p class="text-xs text-gray-500 mt-1">فرمت: سال/ماه/روز</p>
        </div>

        <!-- وضعیت -->
        <div>
            <label class="block text-sm font-medium text-gray-700 mb-1">وضعیت</label>
            <select name="status" class="w-full border border-gray-300 rounded-lg px-3 py-2 focus:outline-none focus:ring-2 focus:ring-blue-500">
                <option value="">همه وضعیت‌ها</option>
                {% for status_value, status_name in status_choices %}
                <option value="{{ status_value }}" {% if request.GET.status == status_value %}selected{% endif %}>{{ status_name }}</option>
                {% endfor %}
            </select>
        </div>

        <!-- شماره میز -->
        <div>
            <label class="block text-sm font-medium text-gray-700 mb-1">شماره میز</label>
            <input type="text" name="table" value="{{ request.GET.table }}"
                   class="w-full border border-gray-300 rounded-lg px-3 py-2 focus:outline-none focus:ring-2 focus:ring-blue-500"
                   placeholder="جستجو بر اساس میز">
        </div>

        <!-- نام مشتری -->
        <div>
            <label class="block text-sm font-medium text-gray-700 mb-1">نام مشتری</label>
            <input type="text" name="customer_name" value="{{ request.GET.customer_name }}"
                   class="w-full border border-gray-300 rounded-lg px-3 py-2 focus:outline-none focus:ring-2 focus:ring-blue-500"
                   placeholder="جستجو بر اساس نام">
        </div>

        <!-- دکمه‌های فیلتر -->
        <div class="lg:col-span-4 flex justify-center space-x-3 space-x-reverse pt-2">
            <button type="submit" class="bg-blue-600 hover:bg-blue-700 text-white px-6 py-2 rounded-lg flex items-center transition duration-200">
                <i class="fas fa-filter ml-2"></i>
                اعمال فیلتر
            </button>

            <a href="{% url 'table:reservation_list' %}" class="bg-gray-500 hover:bg-gray-600 text-white px-6 py-2 rounded-lg transition duration-200">
                حذف فیلتر
            </a>
        </div>
    </form>
</div>

<!-- آمار سریع -->
<div class="mb-6 grid grid-cols-2 md:grid-cols-4 gap-4" id="statsContainer">
    <div class="bg-blue-50 border border-blue-200 rounded-lg p-4 text-center">
        <div class="text-2xl font-bold text-blue-600" id="totalCount">{{ reservations.count }}</div>
        <div class="text-blue-800 text-sm">تعداد کل</div>
    </div>
    <div class="bg-green-50 border border-green-200 rounded-lg p-4 text-center">
        <div class="text-2xl font-bold text-green-600" id="confirmedCount">0</div>
        <div class="text-green-800 text-sm">تأیید شده</div>
    </div>
    <div class="bg-yellow-50 border border-yellow-200 rounded-lg p-4 text-center">
        <div class="text-2xl font-bold text-yellow-600" id="pendingCount">0</div>
        <div class="text-yellow-800 text-sm">در انتظار</div>
    </div>
    <div class="bg-red-50 border border-red-200 rounded-lg p-4 text-center">
        <div class="text-2xl font-bold text-red-600" id="cancelledCount">0</div>
        <div class="text-red-800 text-sm">لغو شده</div>
    </div>
</div>

<!-- لیست رزروها -->
<div class="bg-white rounded-lg shadow-md overflow-hidden">
    {% if reservations %}
    <div class="overflow-x-auto">
        <table class="min-w-full divide-y divide-gray-200" id="reservationsTable">
            <thead class="bg-gray-50">
                <tr>
                    <th class="px-6 py-3 text-right text-xs font-medium text-gray-500 uppercase tracking-wider">کد رزرو</th>
                    <th class="px-6 py-3 text-right text-xs font-medium text-gray-500 uppercase tracking-wider">مشتری</th>
                    <th class="px-6 py-3 text-right text-xs font-medium text-gray-500 uppercase tracking-wider">میز</th>
                    <th class="px-6 py-3 text-right text-xs font-medium text-gray-500 uppercase tracking-wider">تاریخ و زمان</th>
                    <th class="px-6 py-3 text-right text-xs font-medium text-gray-500 uppercase tracking-wider">تعداد مهمان</th>
                    <th class="px-6 py-3 text-right text-xs font-medium text-gray-500 uppercase tracking-wider">وضعیت</th>
                    <th class="px-6 py-3 text-right text-xs font-medium text-gray-500 uppercase tracking-wider">عملیات</th>
                </tr>
            </thead>
            <tbody class="bg-white divide-y divide-gray-200" id="reservationsBody">
                {% for reservation in reservations %}
                <tr class="hover:bg-gray-50 transition duration-150" data-status="{{ reservation.reservation_status }}">
                    <td class="px-6 py-4 whitespace-nowrap">
                        <span class="text-sm font-mono text-blue-600 font-semibold">{{ reservation.reservation_code }}</span>
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap">
                        <div>
                            <div class="text-sm font-medium text-gray-900">{{ reservation.customer_full_name }}</div>
                            <div class="text-sm text-gray-500">{{ reservation.customer_phone }}</div>
                            {% if reservation.special_requests %}
                            <div class="text-xs text-orange-600 mt-1" title="{{ reservation.special_requests }}">
                                <i class="fas fa-star"></i> درخواست ویژه
                            </div>
                            {% endif %}
                        </div>
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap">
                        <span class="text-sm text-gray-900">میز {{ reservation.table.table_number }}</span>
                        <div class="text-xs text-gray-500">ظرفیت: {{ reservation.table.capacity }} نفر</div>
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap">
                        <div class="text-sm text-gray-900">
                            {% if reservation.jalali_reservation_date %}
                                {{ reservation.jalali_reservation_date }}
                            {% else %}
                                <!-- تبدیل تاریخ میلادی به شمسی با JavaScript -->
                                <span class="gregorian-date" data-date="{{ reservation.reservation_date|date:'Y-m-d' }}">
                                    {{ reservation.reservation_date|date:"Y/m/d" }}
                                </span>
                            {% endif %}
                        </div>
                        <div class="text-sm text-gray-500">{{ reservation.start_time|time:"H:i" }} - {{ reservation.end_time|time:"H:i" }}</div>
                        <div class="text-xs text-gray-400">{{ reservation.duration_minutes }} دقیقه</div>
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">
                        <span class="inline-flex items-center">
                            <i class="fas fa-users ml-1 text-gray-400"></i>
                            {{ reservation.guest_count }} نفر
                        </span>
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap">
                        <span class="px-3 py-1 inline-flex text-xs leading-5 font-semibold rounded-full
                            {% if reservation.reservation_status == 'confirmed' %}bg-blue-100 text-blue-800
                            {% elif reservation.reservation_status == 'seated' %}bg-green-100 text-green-800
                            {% elif reservation.reservation_status == 'completed' %}bg-gray-100 text-gray-800
                            {% elif reservation.reservation_status == 'cancelled' %}bg-red-100 text-red-800
                            {% elif reservation.reservation_status == 'no_show' %}bg-orange-100 text-orange-800
                            {% else %}bg-yellow-100 text-yellow-800{% endif %}">
                            {% if reservation.reservation_status == 'confirmed' %}
                                <i class="fas fa-check ml-1"></i>
                            {% elif reservation.reservation_status == 'seated' %}
                                <i class="fas fa-user-check ml-1"></i>
                            {% elif reservation.reservation_status == 'completed' %}
                                <i class="fas fa-flag-checkered ml-1"></i>
                            {% elif reservation.reservation_status == 'cancelled' %}
                                <i class="fas fa-times ml-1"></i>
                            {% elif reservation.reservation_status == 'no_show' %}
                                <i class="fas fa-user-times ml-1"></i>
                            {% else %}
                                <i class="fas fa-clock ml-1"></i>
                            {% endif %}
                            {{ reservation.get_reservation_status_display }}
                        </span>

                        {% if reservation.customer_arrived %}
                        <div class="text-xs text-green-600 mt-1">
                            <i class="fas fa-check-circle"></i> حضور ثبت شده
                        </div>
                        {% endif %}
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm font-medium">
                        <div class="flex space-x-2 space-x-reverse">
                            <!-- مشاهده جزئیات -->
                            <a href="{% url 'table:reservation_detail' reservation.id %}"
                               class="text-blue-600 hover:text-blue-900 p-2 rounded-full hover:bg-blue-50 transition duration-200"
                               title="مشاهده جزئیات">
                                <i class="fas fa-eye"></i>
                            </a>

                            <!-- تأیید رزرو -->
                            {% if reservation.reservation_status == 'pending' %}
                            <a href="{% url 'table:reservation_confirm' reservation.id %}"
                               class="text-green-600 hover:text-green-900 p-2 rounded-full hover:bg-green-50 transition duration-200"
                               title="تأیید رزرو"
                               onclick="return confirm('آیا از تأیید این رزرو مطمئنید؟')">
                                <i class="fas fa-check"></i>
                            </a>
                            {% endif %}

                            <!-- ثبت حضور -->
                            {% if reservation.reservation_status == 'confirmed' %}
                            <a href="{% url 'table:reservation_mark_seated' reservation.id %}"
                               class="text-green-600 hover:text-green-900 p-2 rounded-full hover:bg-green-50 transition duration-200"
                               title="ثبت حضور مشتری"
                               onclick="return confirm('آیا مشتری حاضر شده است؟')">
                                <i class="fas fa-user-check"></i>
                            </a>
                            {% endif %}

                            <!-- لغو رزرو -->
                            {% if reservation.reservation_status == 'pending' or reservation.reservation_status == 'confirmed' %}
                            <a href="{% url 'table:reservation_cancel' reservation.id %}"
                               class="text-red-600 hover:text-red-900 p-2 rounded-full hover:bg-red-50 transition duration-200"
                               title="لغو رزرو"
                               onclick="return confirm('آیا از لغو این رزرو مطمئنید؟')">
                                <i class="fas fa-times"></i>
                            </a>
                            {% endif %}

                            <!-- تکمیل رزرو -->
                            {% if reservation.reservation_status == 'seated' %}
                            <a href="{% url 'table:reservation_mark_completed' reservation.id %}"
                               class="text-gray-600 hover:text-gray-900 p-2 rounded-full hover:bg-gray-50 transition duration-200"
                               title="تکمیل رزرو"
                               onclick="return confirm('آیا رزرو تکمیل شده است؟')">
                                <i class="fas fa-flag-checkered"></i>
                            </a>
                            {% endif %}

                            <!-- ثبت عدم حضور -->
                            {% if reservation.reservation_status == 'confirmed' %}
                            <a href="{% url 'table:reservation_mark_no_show' reservation.id %}"
                               class="text-orange-600 hover:text-orange-900 p-2 rounded-full hover:bg-orange-50 transition duration-200"
                               title="ثبت عدم حضور"
                               onclick="return confirm('آیا مشتری حضور نداشته است؟')">
                                <i class="fas fa-user-times"></i>
                            </a>
                            {% endif %}
                        </div>
                    </td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>

    <!-- اطلاعات صفحه -->
    <div class="bg-white px-4 py-3 border-t border-gray-200 sm:px-6">
        <div class="flex justify-between items-center">
            <div class="text-sm text-gray-700">
                نمایش <span class="font-semibold">{{ reservations.count }}</span> رزرو
            </div>
            <div class="text-sm text-gray-500">
                آخرین به‌روزرسانی: <span id="currentTime"></span>
            </div>
        </div>
    </div>

    {% else %}
    <div class="text-center py-12">
        <i class="fas fa-calendar-times text-gray-300 text-5xl mb-4"></i>
        <h3 class="text-xl font-semibold text-gray-500 mb-2">هیچ رزروی یافت نشد</h3>
        <p class="text-gray-400 mb-4">با تغییر فیلترها دوباره امتحان کنید</p>
        <a href="{% url 'table:reservation_list' %}" class="bg-blue-600 hover:bg-blue-700 text-white px-6 py-3 rounded-lg inline-flex items-center transition duration-200">
            <i class="fas fa-redo ml-2"></i>
            نمایش همه رزروها
        </a>
    </div>
    {% endif %}
</div>

<!-- راهنمای وضعیت‌ها -->
<div class="mt-6 bg-gray-50 rounded-lg p-4 border border-gray-200">
    <h4 class="text-sm font-semibold text-gray-700 mb-3">راهنمای وضعیت‌ها:</h4>
    <div class="grid grid-cols-2 md:grid-cols-3 lg:grid-cols-6 gap-2 text-xs">
        <div class="flex items-center">
            <span class="w-3 h-3 bg-yellow-100 rounded-full mr-2"></span>
            <span class="text-yellow-800">در انتظار تأیید</span>
        </div>
        <div class="flex items-center">
            <span class="w-3 h-3 bg-blue-100 rounded-full mr-2"></span>
            <span class="text-blue-800">تأیید شده</span>
        </div>
        <div class="flex items-center">
            <span class="w-3 h-3 bg-green-100 rounded-full mr-2"></span>
            <span class="text-green-800">حاضر شده</span>
        </div>
        <div class="flex items-center">
            <span class="w-3 h-3 bg-gray-100 rounded-full mr-2"></span>
            <span class="text-gray-800">تکمیل شده</span>
        </div>
        <div class="flex items-center">
            <span class="w-3 h-3 bg-red-100 rounded-full mr-2"></span>
            <span class="text-red-800">لغو شده</span>
        </div>
        <div class="flex items-center">
            <span class="w-3 h-3 bg-orange-100 rounded-full mr-2"></span>
            <span class="text-orange-800">عدم حضور</span>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_scripts %}
<script>
// کتابخانه ساده برای تبدیل تاریخ میلادی به شمسی
function gregorianToJalali(gy, gm, gd) {
    var g_d_m = [0, 31, 59, 90, 120, 151, 181, 212, 243, 273, 304, 334];
    var jy = (gy <= 1600) ? 0 : 979;
    gy -= (gy <= 1600) ? 621 : 1600;
    var gy2 = (gm > 2) ? (gy + 1) : gy;
    var days = (365 * gy) + (parseInt((gy2 + 3) / 4)) - (parseInt((gy2 + 99) / 100)) + (parseInt((gy2 + 399) / 400)) - 80 + gd + g_d_m[gm - 1];
    jy += 33 * (parseInt(days / 12053));
    days %= 12053;
    jy += 4 * (parseInt(days / 1461));
    days %= 1461;
    jy += parseInt((days - 1) / 365);
    if (days > 365) days = (days - 1) % 365;
    var jm = (days < 186) ? 1 + parseInt(days / 31) : 7 + parseInt((days - 186) / 30);
    var jd = 1 + ((days < 186) ? (days % 31) : ((days - 186) % 30));
    return [jy, jm, jd];
}

function formatJalaliDate(jy, jm, jd) {
    return jy + '/' + (jm < 10 ? '0' + jm : jm) + '/' + (jd < 10 ? '0' + jd : jd);
}

document.addEventListener('DOMContentLoaded', function() {
    // تبدیل تاریخ‌های میلادی به شمسی
    function convertGregorianDates() {
        const gregorianElements = document.querySelectorAll('.gregorian-date');

        gregorianElements.forEach(element => {
            const gregorianDate = element.getAttribute('data-date');
            if (gregorianDate) {
                const parts = gregorianDate.split('-');
                if (parts.length === 3) {
                    const gy = parseInt(parts[0]);
                    const gm = parseInt(parts[1]);
                    const gd = parseInt(parts[2]);

                    const jalali = gregorianToJalali(gy, gm, gd);
                    const jalaliDate = formatJalaliDate(jalali[0], jalali[1], jalali[2]);

                    element.textContent = jalaliDate;
                    element.classList.remove('gregorian-date');
                }
            }
        });
    }

    // شمارش وضعیت‌ها
    function countReservationsByStatus() {
        const rows = document.querySelectorAll('#reservationsBody tr[data-status]');
        let confirmedCount = 0;
        let pendingCount = 0;
        let cancelledCount = 0;
        let seatedCount = 0;
        let completedCount = 0;
        let noShowCount = 0;

        rows.forEach(row => {
            const status = row.getAttribute('data-status');
            switch(status) {
                case 'confirmed':
                    confirmedCount++;
                    break;
                case 'pending':
                    pendingCount++;
                    break;
                case 'cancelled':
                    cancelledCount++;
                    break;
                case 'seated':
                    seatedCount++;
                    break;
                case 'completed':
                    completedCount++;
                    break;
                case 'no_show':
                    noShowCount++;
                    break;
            }
        });

        // آپدیت آمار
        document.getElementById('confirmedCount').textContent = confirmedCount;
        document.getElementById('pendingCount').textContent = pendingCount;
        document.getElementById('cancelledCount').textContent = cancelledCount + noShowCount;
    }

    // نمایش زمان جاری
    function updateCurrentTime() {
        const now = new Date();
        const timeString = now.toLocaleTimeString('fa-IR');
        const timeElement = document.getElementById('currentTime');
        if (timeElement) {
            timeElement.textContent = timeString;
        }
    }

    // فیلتر لحظه‌ای
    function setupRealTimeFilter() {
        const searchInputs = document.querySelectorAll('input[type="text"]');

        searchInputs.forEach(input => {
            input.addEventListener('input', function() {
                const filter = this.value.toLowerCase();
                const table = this.name;
                const rows = document.querySelectorAll('#reservationsBody tr');
                let visibleCount = 0;

                rows.forEach(row => {
                    let text = '';
                    if (table === 'table') {
                        text = row.querySelector('td:nth-child(3)').textContent.toLowerCase();
                    } else if (table === 'customer_name') {
                        text = row.querySelector('td:nth-child(2)').textContent.toLowerCase();
                    }

                    if (text.includes(filter)) {
                        row.style.display = '';
                        visibleCount++;
                    } else {
                        row.style.display = 'none';
                    }
                });

                // آپدیت تعداد کل
                document.getElementById('totalCount').textContent = visibleCount;
                countReservationsByStatus();
            });
        });
    }

    // راهنمای وضعیت‌ها
    function setupStatusHover() {
        const statusBadges = document.querySelectorAll('td:nth-child(6) span');

        statusBadges.forEach(badge => {
            badge.addEventListener('mouseenter', function() {
                this.style.transform = 'scale(1.05)';
            });

            badge.addEventListener('mouseleave', function() {
                this.style.transform = 'scale(1)';
            });
        });
    }

    // اجرای توابع
    convertGregorianDates();
    countReservationsByStatus();
    updateCurrentTime();
    setupRealTimeFilter();
    setupStatusHover();

    // به روزرسانی زمان هر دقیقه
    setInterval(updateCurrentTime, 60000);
});
</script>
{% endblock %}