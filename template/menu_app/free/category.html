<div class="header-categories-wrapper relative -mx-4">
    <!-- کانتینر اسکرول با پدینگ داخلی -->
    <div class="categories-scroll no-scrollbar px-4">
        <!-- 1. دکمه همه (All) - با آیکون جدید و بک‌گراند سیاه سفید -->
        <div class="category-item category-active grayscale-bg" data-category="all">
            <div class="category-icon">
                <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                    <rect x="3" y="3" width="7" height="7"></rect>
                    <rect x="14" y="3" width="7" height="7"></rect>
                    <rect x="3" y="14" width="7" height="7"></rect>
                    <rect x="14" y="14" width="7" height="7"></rect>
                </svg>
            </div>
            <span class="category-name">همه</span>
        </div>

        <!-- 2. حلقه دسته‌بندی‌ها -->
        {% for menu_category in menu_categories %}
        <div class="category-item" data-category="{{ menu_category.id }}">
            {% if menu_category.displayImage %}
                <img loading="lazy" src="{{ menu_category.displayImage.url }}" alt="{{ menu_category.category.title }}" class="category-icon object-cover">
            {% else %}
                <div class="category-icon default-icon-bg">
                    <span style="font-size: 10px; font-weight: bold;">{{ menu_category.category.title|slice:":2" }}</span>
                </div>
            {% endif %}
            <span class="category-name">{{ menu_category.category.title }}</span>
        </div>
        {% endfor %}

        <!-- فضای خالی انتهایی -->
        <div style="min-width: 10px;"></div>
    </div>
</div>

<style>
    /* --- کانتینر اصلی --- */
    .header-categories-wrapper {
        position: relative;
        width: 100%;
        overflow: hidden;
    }

    .categories-scroll {
        display: flex;
        align-items: flex-start;
        gap: 12px;
        overflow-x: auto;
        padding-bottom: 10px;
        padding-top: 5px;
        padding-left: 16px;
        padding-right: 16px;
        scroll-behavior: smooth;
        -webkit-overflow-scrolling: touch;
        scroll-padding-left: 16px;
        scroll-padding-right: 16px;
    }

    /* مخفی کردن اسکرول‌بار */
    .no-scrollbar::-webkit-scrollbar { display: none; }
    .no-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }

    /* --- استایل آیتم‌ها --- */
    .category-item {
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: flex-start;
        cursor: pointer;
        min-width: 64px;
        max-width: 72px;
        flex-shrink: 0;
        transition: all 0.2s ease;
        -webkit-tap-highlight-color: transparent;
    }

    .category-icon {
        width: 50px;
        height: 50px;
        border-radius: 16px;
        background-color: #f3f4f6;
        color: #6b7280;
        display: flex;
        align-items: center;
        justify-content: center;
        margin-bottom: 6px;
        box-shadow: 0 2px 5px rgba(0,0,0,0.05);
        border: 2px solid transparent;
        overflow: hidden;
    }

    .category-name {
        font-size: 11px;
        color: #4b5563;
        text-align: center;
        line-height: 1.3;
        font-weight: 500;
        display: -webkit-box;
        -webkit-line-clamp: 2;
        -webkit-box-orient: vertical;
        overflow: hidden;
        width: 100%;
        white-space: normal;
    }

    /* --- حالت Active --- */
    .category-item.category-active .category-icon {
        background-color: #fff;
        border-color: #3b82f6;
        color: #3b82f6;
        transform: translateY(-2px);
        box-shadow: 0 4px 12px rgba(59, 130, 246, 0.25);
    }
    .category-item.category-active .category-name {
        color: #1d4ed8;
        font-weight: 700;
    }

    .default-icon-bg { background: linear-gradient(135deg, #e5e7eb 0%, #d1d5db 100%); }

    /* --- استایل سیاه سفید برای دکمه همه --- */
    .grayscale-bg .category-icon {
        background-color: #6b7280 !important;
        color: #f3f4f6 !important;
        border-color: #4b5563 !important;
    }

    .grayscale-bg.category-active .category-icon {
        background-color: #4b5563 !important;
        border-color: #1f2937 !important;
        color: #ffffff !important;
        box-shadow: 0 4px 12px rgba(75, 85, 99, 0.25) !important;
    }

    .grayscale-bg.category-active .category-name {
        color: #1f2937 !important;
    }

    /* مد تاریک */
    @media (prefers-color-scheme: dark) {
        .category-name { color: #9ca3af; }
        .category-icon { background-color: #1f2937; color: #9ca3af; }
        .category-item.category-active .category-icon {
            background-color: #1f2937;
            border-color: #60a5fa;
            color: #60a5fa;
        }
        .category-item.category-active .category-name { color: #60a5fa; }

        /* استایل سیاه سفید در مد تاریک */
        .grayscale-bg .category-icon {
            background-color: #374151 !important;
            color: #e5e7eb !important;
            border-color: #4b5563 !important;
        }

        .grayscale-bg.category-active .category-icon {
            background-color: #4b5563 !important;
            border-color: #9ca3af !important;
            color: #ffffff !important;
        }

        .grayscale-bg.category-active .category-name {
            color: #e5e7eb !important;
        }
    }
</style>

<script>
document.addEventListener('DOMContentLoaded', function() {
    // -----------------------------------------------------------
    // 0. تزریق استایل‌های ضروری برای عملکرد صحیح اسکرول (فقط هدر)
    // -----------------------------------------------------------
    const style = document.createElement('style');
    style.innerHTML = `
        /* وقتی اسکرول شد، بخش بالایی هدر جمع شود */
        .header.scrolled .header-top {
            height: 0 !important;
            opacity: 0 !important;
            overflow: hidden !important;
            padding: 0 !important;
            margin: 0 !important;
            pointer-events: none;
        }

        /* انیمیشن نرم برای تغییرات */
        .header, .header-top, .main-content {
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }
    `;
    document.head.appendChild(style);

    // 1. تعریف متغیرها
    const header = document.querySelector('.header');
    const headerTop = document.querySelector('.header-top');
    const mainContent = document.querySelector('.main-content');
    const categoriesScroll = document.querySelector('.categories-scroll');
    const SCROLL_THRESHOLD = 50;
    let isHandlingClick = false;

    // 2. تابع تنظیم فاصله بالای محتوا
    function updateMainContentPadding() {
        if (!mainContent || !header) return;
        const headerHeight = header.getBoundingClientRect().height;
        mainContent.style.paddingTop = `${headerHeight + 20}px`;
    }

    // 3. تابع مدیریت اسکرول صفحه
    function handleScroll() {
        if (isHandlingClick) return;
        const currentScrollY = window.scrollY;

        if (currentScrollY > SCROLL_THRESHOLD) {
            if (!header.classList.contains('scrolled')) {
                header.classList.add('scrolled');
                setTimeout(updateMainContentPadding, 300);
            }
        } else {
            if (header.classList.contains('scrolled')) {
                header.classList.remove('scrolled');
                setTimeout(updateMainContentPadding, 300);
            }
        }
    }

    // 4. تابع اسکرول نرم به ابتدای لیست غذاها
    function scrollToFoods() {
        header.classList.add('scrolled');
        window.scrollTo({
            top: 0,
            behavior: 'smooth'
        });
        setTimeout(updateMainContentPadding, 350);
    }

    // 5. تابع اصلی فیلتر کردن غذاها
    function filterFoodsByCategory(categoryId) {
        const allFoodItems = document.querySelectorAll('.food-item');
        const foodGrid = document.querySelector('.food-grid');
        let hasVisibleItems = false;

        const existingMessage = document.querySelector('.no-food-message');
        if (existingMessage) existingMessage.remove();

        allFoodItems.forEach(item => {
            const itemCategory = item.getAttribute('data-category');

            if (categoryId === 'all' || itemCategory === categoryId) {
                item.style.display = 'block';
                requestAnimationFrame(() => {
                    item.style.opacity = '1';
                    item.style.transform = 'translateY(0)';
                });
                hasVisibleItems = true;
            } else {
                item.style.opacity = '0';
                item.style.transform = 'translateY(20px)';
                setTimeout(() => {
                    item.style.display = 'none';
                }, 300);
            }
        });

        if (!hasVisibleItems) {
            setTimeout(() => {
                const messageDiv = document.createElement('div');
                messageDiv.className = 'no-food-message col-span-full w-full text-center py-12 text-gray-400 fade-in';
                messageDiv.innerHTML = `
                    <div class="flex flex-col items-center justify-center">
                        <i class="fas fa-utensils text-4xl mb-3 opacity-50"></i>
                        <p class="text-base font-medium">هیچ غذایی در این دسته موجود نیست</p>
                    </div>
                `;
                foodGrid.appendChild(messageDiv);
            }, 300);
        }
    }

    // 6. تابع اسکرول اتوماتیک برای دسته‌بندی‌ها - فقط اسکرول، بدون تغییر ظاهر
    function autoScrollCategories(clickedItem) {
        if (!categoriesScroll) return;

        // محاسبه موقعیت آیتم کلیک شده
        const containerRect = categoriesScroll.getBoundingClientRect();
        const itemRect = clickedItem.getBoundingClientRect();

        // محاسبه مرکز آیتم
        const itemCenter = itemRect.left + itemRect.width / 2;
        const containerCenter = containerRect.left + containerRect.width / 2;

        // محاسبه میزان اسکرول مورد نیاز
        const scrollOffset = itemCenter - containerCenter;

        // اسکرول نرم به موقعیت آیتم
        categoriesScroll.scrollBy({
            left: scrollOffset,
            behavior: 'smooth'
        });

        // بررسی موقعیت برای بازگشت به ابتدا
        const maxScrollLeft = categoriesScroll.scrollWidth - categoriesScroll.clientWidth;
        const currentScroll = categoriesScroll.scrollLeft;

        // اگر در انتهای لیست هستیم، به ابتدا برگرد
        if (currentScroll >= maxScrollLeft - 10) {
            setTimeout(() => {
                categoriesScroll.scrollTo({
                    left: 0,
                    behavior: 'smooth'
                });
            }, 500);
        }
    }

    // 7. تابع مدیریت کلیک روی دسته‌بندی‌ها
    function handleCategoryClick(e) {
        const categoryItem = e.target.closest('.category-item');
        if (!categoryItem) return;

        isHandlingClick = true;

        // مدیریت کلاس اکتیو
        document.querySelectorAll('.category-item').forEach(el => {
            el.classList.remove('category-active');
        });
        categoryItem.classList.add('category-active');

        // دریافت ID و فیلتر غذاها
        const categoryId = categoryItem.getAttribute('data-category');
        filterFoodsByCategory(categoryId);

        // اسکرول اتوماتیک دسته‌بندی‌ها - فقط این قابلیت اضافه شده
        autoScrollCategories(categoryItem);

        // مدیریت اسکرول صفحه اصلی
        if (window.scrollY > SCROLL_THRESHOLD) {
            header.classList.add('scrolled');

            setTimeout(() => {
                window.scrollTo({ top: 0, behavior: 'smooth' });
            }, 100);

            setTimeout(updateMainContentPadding, 300);
        }

        setTimeout(() => {
            isHandlingClick = false;
        }, 500);
    }

    // 8. اتصال رویدادها
    window.addEventListener('scroll', handleScroll);
    window.addEventListener('resize', updateMainContentPadding);
    document.addEventListener('click', handleCategoryClick);

    // 9. اجرای اولیه
    if (window.scrollY > SCROLL_THRESHOLD) {
        header.classList.add('scrolled');
    }

    setTimeout(updateMainContentPadding, 100);
});
</script>